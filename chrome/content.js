(function(){const o={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY"},i=e=>new Promise((n,t)=>{chrome.runtime.sendMessage(e,a=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):n(a)})});function m(){let e=[],n=!1;return async a=>{if(e.push(a),!n){for(n=!0;e.length;)await e.shift()();n=!1}}}let s=m();function d(){i({cmd:o.ELEMENT_ACTION,data:{action:"play",status:"sending"}}).catch(e=>{console.log(e)})}function c(){i({cmd:o.ELEMENT_ACTION,data:{action:"pause",status:"sending"}}).catch(e=>{console.log(e)})}function u(e){const n=e.target;n&&i({cmd:o.ELEMENT_ACTION,data:{action:"seeked",status:"sending",mediaCurrentTime:n.currentTime}}).catch(t=>{console.log(t)})}function l(e){e.addEventListener("play",d),e.addEventListener("pause",c),e.addEventListener("seeking",u)}function N(e){e.removeEventListener("seeking",u),e.removeEventListener("play",d),e.removeEventListener("pause",c)}function T(e,n,t,a){return new Promise(E=>{if(n=="pause"&&e.paused==!0||n=="play"&&e.paused==!1)return E("no genero evento con exito");e.removeEventListener(n,t);const _=()=>{e.addEventListener(n,t),e.removeEventListener(n,_),E("no genero evento con exito")};e.addEventListener(n,_),a()})}function A(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let a=0;a<8;a++){const E=Math.floor(Math.random()*62);t+=e.charAt(E)}return t}function S(e){try{e.crossOrigin="anonymous";let n=document.createElement("canvas");n.width=100,n.height=56;const t=n.getContext("2d");return t?(t.drawImage(e,0,0,n.width,n.height),n.toDataURL("image/png")):void 0}catch(n){console.log(n)}}let r=[];function L(){let e=document.querySelectorAll("video");const n=Array.from(e).map((t,a)=>{let E=S(t);return{number:A(),img:E,element:t,duration:t.duration}});return r=n,n.map(t=>({number:t.number,img:t.img,duration:t.duration}))}const f={[o.ELEMENT_ACTION]:async e=>{if(e.data.status=="received"){let n=r.find(t=>t.number==e.data.number);if(n){let t=n.element;e.data.action=="play"?s(async()=>{await T(t,"play",d,()=>{n.element.play()})}):e.data.action=="pause"?s(async()=>{await T(t,"pause",c,()=>{n.element.pause()})}):e.data.action=="seeked"&&s(async()=>{await T(t,"seeking",u,()=>{e.data.dataSeek?t.currentTime=Math.max(0,t.currentTime+e.data.dataSeek):t.currentTime=Math.max(0,e.data.mediaCurrentTime)})})}}return{status:"ok"}},[o.GET_VIDEOS_DATA]:async e=>{let n=L();return i({...e,cmd:o.RESULT_VIDEOS_DATA,data:n}),{status:"ok"}},[o.ADD_EVENTS_ELEMENT]:async e=>{let n=r.find(t=>t.number==e.data.number);return n&&(console.log("addEvents",e),l(n.element)),{status:"ok"}},[o.REMOVE_EVENTS_ELEMENTS]:async e=>{let n=r.find(t=>t.number==e.data.number);return n&&(console.log("Remove Events",e),N(n.element)),{status:"ok"}},[o.CHECK_CONNECTION]:async()=>({message:"connected"})};chrome.runtime.onMessage.addListener(function(e,n,t){let a=f[e.cmd];if(a)return a(e).then(E=>{t(E)}).catch(E=>{t({err:E})}),!0;t({error:"no existe tal accion"})}),console.log("ahiseve page")})();
