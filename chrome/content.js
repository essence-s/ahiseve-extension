(function(){const r={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",CHECK_CONNECTION_UI:"CHECK_CONNECTION_UI",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY",DISPLAY_VIDEOS_ON_SELECTED_PAGE:"DISPLAY_VIDEOS_ON_SELECTED_PAGE"},i=e=>new Promise((n,t)=>{chrome.runtime.sendMessage(e,a=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):n(a)})});function N(){let e=[],n=!1;return async a=>{if(e.push(a),!n){for(n=!0;e.length;)await e.shift()();n=!1}}}let d=N();function u(){i({cmd:r.ELEMENT_ACTION,data:{action:"play",status:"sending"}}).catch(e=>{console.log(e)})}function c(){i({cmd:r.ELEMENT_ACTION,data:{action:"pause",status:"sending"}}).catch(e=>{console.log(e)})}function _(e){const n=e.target;n&&i({cmd:r.ELEMENT_ACTION,data:{action:"seeked",status:"sending",mediaCurrentTime:n.currentTime}}).catch(t=>{console.log(t)})}function I(e){e.addEventListener("play",u),e.addEventListener("pause",c),e.addEventListener("seeking",_)}function S(e){e.removeEventListener("seeking",_),e.removeEventListener("play",u),e.removeEventListener("pause",c)}function T(e,n,t,a){return new Promise(E=>{if(n=="pause"&&e.paused==!0||n=="play"&&e.paused==!1)return E("no genero evento con exito");e.removeEventListener(n,t);const s=()=>{e.addEventListener(n,t),e.removeEventListener(n,s),E("no genero evento con exito")};e.addEventListener(n,s),a()})}function m(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let a=0;a<8;a++){const E=Math.floor(Math.random()*62);t+=e.charAt(E)}return t}function l(e){try{e.crossOrigin="anonymous";let n=document.createElement("canvas");n.width=100,n.height=56;const t=n.getContext("2d");return t?(t.drawImage(e,0,0,n.width,n.height),n.toDataURL("image/png")):void 0}catch(n){console.log(n)}}let o=[];function A(){let e=document.querySelectorAll("video");return Array.from(e).reduce((n,t)=>{if(t.duration>0){let a={};const E=o.find(s=>s.element===t);E?a={number:E.number,img:l(t),element:t,duration:t.duration}:(a={number:m(),img:l(t),element:t,duration:t.duration},o.push(a)),n.push(a)}return n},[])}const L=m(),O={[r.ELEMENT_ACTION]:async e=>{if(e.data.status=="received"){let n=o.find(t=>t.number==e.data.number);if(n){let t=n.element;e.data.action=="play"?d(async()=>{await T(t,"play",u,()=>{n.element.play()})}):e.data.action=="pause"?d(async()=>{await T(t,"pause",c,()=>{n.element.pause()})}):e.data.action=="seeked"&&d(async()=>{await T(t,"seeking",_,()=>{e.data.dataSeek?t.currentTime=Math.max(0,t.currentTime+e.data.dataSeek):t.currentTime=Math.max(0,e.data.mediaCurrentTime)})})}}return{status:"ok"}},[r.GET_VIDEOS_DATA]:async e=>{const n=A().map(t=>({number:t.number,img:t.img,duration:t.duration}));return i({...e,cmd:r.RESULT_VIDEOS_DATA,data:{videosPackageID:L,videos:n}}),{status:"ok"}},[r.ADD_EVENTS_ELEMENT]:async e=>{let n=o.find(t=>t.number==e.data.number);return n&&(console.log("addEvents",e),I(n.element)),{status:"ok"}},[r.REMOVE_EVENTS_ELEMENTS]:async e=>{let n=o.find(t=>t.number==e.data.number);return n&&(console.log("Remove Events",e),S(n.element)),{status:"ok"}},[r.CHECK_CONNECTION]:async()=>({message:"connected"}),[r.GET_VIDEO_INFO]:async e=>{const n=o.find(t=>t.number==e.data.number);if(n){const t={number:n.number,currentTime:n.element.currentTime,duration:n.element.duration,paused:n.element.paused,playbackRate:n.element.playbackRate,volume:n.element.volume,muted:n.element.muted,ended:n.element.ended};return{cmd:r.RESULT_VIDEO_INFO,data:t}}return{status:"ok"}}};chrome.runtime.onMessage.addListener(function(e,n,t){let a=O[e.cmd];return a?(a(e).then(E=>{t(E)}).catch(E=>{t({err:E})}),!0):!1}),console.log("ahiseve page")})();
