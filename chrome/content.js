(function(){const r={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",CHECK_CONNECTION_UI:"CHECK_CONNECTION_UI",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY",DISPLAY_VIDEOS_ON_SELECTED_PAGE:"DISPLAY_VIDEOS_ON_SELECTED_PAGE",HIDDEN_UI:"HIDDEN_UI",SAVE_TAB_INFO:"SAVE_TAB_INFO",ENABLE_VIDEO_DETECTOR:"ENABLE_VIDEO_DETECTOR",DISABLE_VIDEO_DETECTOR:"DISABLE_VIDEO_DETECTOR",VIDEO_DETECTOR_STATUS:"VIDEO_DETECTOR_STATUS"},i=e=>new Promise((n,t)=>{chrome.runtime.sendMessage(e,E=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):n(E)})});function l(){let e=[],n=!1;return async E=>{if(e.push(E),!n){for(n=!0;e.length;)await e.shift()();n=!1}}}let d=l();function _(){i({cmd:r.ELEMENT_ACTION,data:{action:"play",status:"sending"}}).catch(e=>{console.log(e)})}function u(){i({cmd:r.ELEMENT_ACTION,data:{action:"pause",status:"sending"}}).catch(e=>{console.log(e)})}function T(e){const n=e.target;n&&i({cmd:r.ELEMENT_ACTION,data:{action:"seeked",status:"sending",mediaCurrentTime:n.currentTime}}).catch(t=>{console.log(t)})}function N(e){e.addEventListener("play",_),e.addEventListener("pause",u),e.addEventListener("seeking",T)}function O(e){e.removeEventListener("seeking",T),e.removeEventListener("play",_),e.removeEventListener("pause",u)}function c(e,n,t,E){return new Promise(a=>{if(n=="pause"&&e.paused==!0||n=="play"&&e.paused==!1)return a("no genero evento con exito");e.removeEventListener(n,t);const s=()=>{e.addEventListener(n,t),e.removeEventListener(n,s),a("no genero evento con exito")};e.addEventListener(n,s),E()})}function m(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let E=0;E<8;E++){const a=Math.floor(Math.random()*62);t+=e.charAt(a)}return t}function I(e){try{e.crossOrigin="anonymous";let n=document.createElement("canvas");n.width=100,n.height=56;const t=n.getContext("2d");return t?(t.drawImage(e,0,0,n.width,n.height),n.toDataURL("image/png")):void 0}catch(n){console.log(n)}}let o=[];function A(){let e=document.querySelectorAll("video");return Array.from(e).reduce((n,t)=>{if(t.duration>0){let E={};const a=o.find(s=>s.element===t);a?E={number:a.number,img:I(t),element:t,duration:t.duration}:(E={number:m(),img:I(t),element:t,duration:t.duration},o.push(E)),n.push(E)}return n},[])}const D=m(),S={[r.ELEMENT_ACTION]:async e=>{if(e.data.status=="received"){let n=o.find(t=>t.number==e.data.number);if(n){let t=n.element;e.data.action=="play"?d(async()=>{await c(t,"play",_,()=>{n.element.play()})}):e.data.action=="pause"?d(async()=>{await c(t,"pause",u,()=>{n.element.pause()})}):e.data.action=="seeked"&&d(async()=>{await c(t,"seeking",T,()=>{e.data.dataSeek?t.currentTime=Math.max(0,t.currentTime+e.data.dataSeek):t.currentTime=Math.max(0,e.data.mediaCurrentTime)})})}}return{status:"ok"}},[r.GET_VIDEOS_DATA]:async e=>{const n=A().map(t=>({number:t.number,img:t.img,duration:t.duration}));return i({...e,cmd:r.RESULT_VIDEOS_DATA,data:{videosPackageID:D,videos:n}}),{status:"ok"}},[r.ADD_EVENTS_ELEMENT]:async e=>{let n=o.find(t=>t.number==e.data.number);return n&&(console.log("addEvents",e),N(n.element)),{status:"ok"}},[r.REMOVE_EVENTS_ELEMENTS]:async e=>{let n=o.find(t=>t.number==e.data.number);return n&&(console.log("Remove Events",e),O(n.element)),{status:"ok"}},[r.CHECK_CONNECTION]:async()=>({message:"connected"}),[r.GET_VIDEO_INFO]:async e=>{const n=o.find(t=>t.number==e.data.number);if(n){const t={number:n.number,currentTime:n.element.currentTime,duration:n.element.duration,paused:n.element.paused,playbackRate:n.element.playbackRate,volume:n.element.volume,muted:n.element.muted,ended:n.element.ended};return{cmd:r.RESULT_VIDEO_INFO,data:t}}return{status:"ok"}}};chrome.runtime.onMessage.addListener(function(e,n,t){let E=S[e.cmd];return E?(E(e).then(a=>{t(a)}).catch(a=>{t({err:a})}),!0):!1}),console.log("ahiseve page")})();
