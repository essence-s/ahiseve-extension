(function(){const E={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY"},i=e=>new Promise((n,t)=>{chrome.runtime.sendMessage(e,a=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):n(a)})});function m(){let e=[],n=!1;return async a=>{if(e.push(a),!n){for(n=!0;e.length;)await e.shift()();n=!1}}}let s=m();function d(){i({cmd:E.ELEMENT_ACTION,data:{action:"play",status:"sending"}}).catch(e=>{console.log(e)})}function c(){i({cmd:E.ELEMENT_ACTION,data:{action:"pause",status:"sending"}}).catch(e=>{console.log(e)})}function u(e){const n=e.target;n&&i({cmd:E.ELEMENT_ACTION,data:{action:"seeked",status:"sending",mediaCurrentTime:n.currentTime}}).catch(t=>{console.log(t)})}function l(e){e.addEventListener("play",d),e.addEventListener("pause",c),e.addEventListener("seeking",u)}function N(e){e.removeEventListener("seeking",u),e.removeEventListener("play",d),e.removeEventListener("pause",c)}function T(e,n,t,a){return new Promise(o=>{if(n=="pause"&&e.paused==!0||n=="play"&&e.paused==!1)return o("no genero evento con exito");e.removeEventListener(n,t);const _=()=>{e.addEventListener(n,t),e.removeEventListener(n,_),o("no genero evento con exito")};e.addEventListener(n,_),a()})}function I(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let a=0;a<8;a++){const o=Math.floor(Math.random()*62);t+=e.charAt(o)}return t}function A(e){try{e.crossOrigin="anonymous";let n=document.createElement("canvas");n.width=100,n.height=56;const t=n.getContext("2d");return t?(t.drawImage(e,0,0,n.width,n.height),n.toDataURL("image/png")):void 0}catch(n){console.log(n)}}let r=[];function S(){let e=document.querySelectorAll("video");const n=Array.from(e).map((t,a)=>{let o=A(t);return{number:I(),img:o,element:t,duration:t.duration}});return r=n,n.map(t=>({number:t.number,img:t.img,duration:t.duration}))}const L={[E.ELEMENT_ACTION]:async e=>{if(e.data.status=="received"){let n=r.find(t=>t.number==e.data.number);if(n){let t=n.element;e.data.action=="play"?s(async()=>{await T(t,"play",d,()=>{n.element.play()})}):e.data.action=="pause"?s(async()=>{await T(t,"pause",c,()=>{n.element.pause()})}):e.data.action=="seeked"&&s(async()=>{await T(t,"seeking",u,()=>{e.data.dataSeek?t.currentTime=Math.max(0,t.currentTime+e.data.dataSeek):t.currentTime=Math.max(0,e.data.mediaCurrentTime)})})}}return{status:"ok"}},[E.GET_VIDEOS_DATA]:async e=>{let n=S();return i({...e,cmd:E.RESULT_VIDEOS_DATA,data:n}),{status:"ok"}},[E.ADD_EVENTS_ELEMENT]:async e=>{let n=r.find(t=>t.number==e.data.number);return n&&(console.log("addEvents",e),l(n.element)),{status:"ok"}},[E.REMOVE_EVENTS_ELEMENTS]:async e=>{let n=r.find(t=>t.number==e.data.number);return n&&(console.log("Remove Events",e),N(n.element)),{status:"ok"}},[E.CHECK_CONNECTION]:async()=>({message:"connected"}),[E.GET_VIDEO_INFO]:async e=>{const n=r.find(t=>t.number==e.data.number);if(n){const t={number:n.number,currentTime:n.element.currentTime,duration:n.element.duration,paused:n.element.paused,playbackRate:n.element.playbackRate,volume:n.element.volume,muted:n.element.muted,ended:n.element.ended};return{cmd:E.RESULT_VIDEO_INFO,data:t}}return{status:"ok"}}};chrome.runtime.onMessage.addListener(function(e,n,t){let a=L[e.cmd];if(a)return a(e).then(o=>{t(o)}).catch(o=>{t({err:o})}),!0;t({error:"no existe tal accion"})}),console.log("ahiseve page")})();
