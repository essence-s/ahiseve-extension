const c={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY"},_=(a,t,o)=>new Promise((e,n)=>{chrome.tabs.sendMessage(Number(a),t,o,r=>{chrome.runtime.lastError?n(chrome.runtime.lastError.message):e(r)})}),d={},s=async a=>{if(!a)return"";if(d[a])return d[a];try{const t=await fetch(a);if(!t.ok)return"";const o=await t.blob(),e=new FileReader,n=await new Promise(r=>{e.onloadend=()=>r(e.result),e.readAsDataURL(o)});return d[a]=n,n}catch{return""}},I=()=>new Promise((a,t)=>{try{chrome.tabs.query({},function(o){Promise.all(o.map(async e=>{const n=await s(e.favIconUrl);return{id:e.id,favIconUrl:n,title:e.title,url:e.url}})).then(e=>a(e))})}catch(o){console.log(o),t(o)}}),N=(a,t)=>new Promise((o,e)=>{_(a,t).then(n=>{console.log("Mensaje enviado:",n),o(n)}).catch(n=>{console.log("Error al enviar mensaje:",n),(typeof browser<"u"?browser.scripting:chrome.scripting).executeScript({target:{tabId:Number(a),allFrames:!0},files:["content.js"]}).then(()=>{console.log("script execute"),_(a,t).then(r=>{console.log("Mensaje enviado:",r),o(r)}).catch(r=>{console.log("Error al enviar mensaje 2:",r),e(r)})})})});chrome.runtime.onInstalled.addListener(()=>{console.log("installed")});let l=null,E=null;function S(){return new Promise(a=>{E&&Object.keys(E).length==0?chrome.storage.local.get(["dataG"],function(t){t.dataG&&(E=JSON.parse(t.dataG)),a("")}):a("")})}const A=a=>{chrome.storage.local.set({dataG:JSON.stringify(a)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener((a,t,o)=>(S().then(async()=>{if(a.cmd==c.ELEMENT_ACTION)if(a.data.status=="sending"){if(!l){console.log("mainAppTabId null");return}_(l,{cmd:a.cmd,data:a.data})}else{if(!E){console.log("no hay elemento seleccionado");return}_(E.tabId,{cmd:a.cmd,data:{...a.data,number:E.number}})}else if(a.cmd==c.CHECK_ELEMENT_VIDEO_SELECTED){let e={selected:!1};if(!E){console.log("no hay elemento seleccionado");return}Object.keys(E).length!=0&&(e={selected:!0}),o({cmd:c.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:e})}else if(a.cmd==c.GET_TABS){const e=await I();o({...a,cmd:c.RESULT_TABS,data:e})}else if(a.cmd==c.GET_VIDEOS_DATA)N(a.data.tabId,{...a,myTabId:t.tab?.id});else if(a.cmd==c.RESULT_VIDEOS_DATA){const e=a.data.map(n=>({...n,frameId:t.frameId}));_(a.myTabId,{...a,cmd:c.RESULT_VIDEOS_DATA,data:e})}else if(a.cmd==c.ADD_EVENTS_ELEMENT){const e=a.data.tabId,n=a.data.number,r=a.data.img,i=a.data.favIconUrl,T=a.data.frameId;if(E&&E.tabId)try{(await _(E.tabId,{cmd:c.REMOVE_EVENTS_ELEMENTS,data:{number:E.number}})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(m){console.log("error remove",m)}await _(Number(e),{cmd:c.ADD_EVENTS_ELEMENT,data:{number:n}}),E={img:r,tabId:e,number:n,favIconUrl:i,frameId:T},A(E)}else if(a.cmd===c.APP_INSTANCE_ALIVE){const e=t.tab?.id;e!==void 0&&(l!==null&&l!==e&&_(l,{cmd:c.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),l=e,_(l,{cmd:c.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}else if(a.cmd===c.GET_VIDEO_INFO)try{if(!E){console.log("no hay elemento seleccionado");return}o(await _(E.tabId,{...a,data:{number:E.number}},{frameId:E.frameId}))}catch(e){console.log(e)}o({data:"no se encontro coincidencia"})}),!0));
