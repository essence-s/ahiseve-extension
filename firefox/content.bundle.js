(function(){const o={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION"},s=e=>new Promise((n,t)=>{chrome.runtime.sendMessage(e,a=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):n(a)})}),_=e=>{window.postMessage(e,"*")};function m(){let e=[],n=!1;return async a=>{if(e.push(a),!n){for(n=!0;e.length;)await e.shift()();n=!1}}}let r=m();function d(e){s({cmd:o.ELEMENT_ACTION,data:{action:"play",status:"sending"}}).catch(n=>{console.log(n)})}function c(e){s({cmd:o.ELEMENT_ACTION,data:{action:"pause",status:"sending"}}).catch(n=>{console.log(n)})}function T(e){s({cmd:o.ELEMENT_ACTION,data:{action:"seeked",status:"sending",mediaCurrentTime:e.target.currentTime}}).catch(n=>{console.log(n)})}function g(e){e.addEventListener("play",d),e.addEventListener("pause",c),e.addEventListener("seeking",T)}function L(e){e.removeEventListener("seeking",T),e.removeEventListener("play",d),e.removeEventListener("pause",c)}function u(e,n,t,a){return new Promise(E=>{if(n=="pause"&&e.paused==!0||n=="play"&&e.paused==!1)return E("no genero evento con exito");e.removeEventListener(n,t);const l=()=>{e.addEventListener(n,t),e.removeEventListener(n,l),E("no genero evento con exito")};e.addEventListener(n,l),a()})}function f(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let a=0;a<8;a++){const E=Math.floor(Math.random()*62);t+=e.charAt(E)}return t}function S(e){try{e.crossOrigin="anonymous";let n=document.createElement("canvas");return n.width=100,n.height=56,n.getContext("2d").drawImage(e,0,0,n.width,n.height),n.toDataURL("image/png")}catch(n){console.log(n)}}let i=[];function N(){let e=document.querySelectorAll("video");const n=Array.from(e).map((t,a)=>{let E=S(t);return{number:f(),img:E,element:t}});return i=n,n.map(t=>({number:t.number,img:t.img}))}const C={ELEMENT_ACTION:e=>{if(e.data.status=="received"){let n=i.find(t=>t.number==e.data.idNumber);if(n){let t=n.element;e.data.action=="play"?r(async()=>{await u(t,"play",d,()=>{n.element.play()})}):e.data.action=="pause"?r(async()=>{await u(t,"pause",c,()=>{n.element.pause()})}):e.data.action=="seeked"&&r(async()=>{await u(t,"seeking",T,()=>{e.data.dataSeek?t.currentTime=Math.max(0,t.currentTime+e.data.dataSeek):t.currentTime=Math.max(0,e.data.mediaCurrentTime)})})}}else e.data.status=="sending"&&window.postMessage({cmd:e.cmd,data:e.data},"*");return{status:"ok"}},GET_VIDEOS_DATA:async(e,n)=>{let t=N();return s({...e,cmd:o.RESULT_VIDEOS_DATA,data:t}),{status:"ok"}},RESULT_VIDEOS_DATA:async(e,n)=>(_(e),{status:"ok"}),RESULT_CHECK_ELEMENT_VIDEO_SELECTED:e=>(window.postMessage({cmd:o.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:e.data},"*"),{status:"ok"}),ADD_EVENTS_ELEMENT:e=>{let n=i.find(t=>t.number==e.data.idNumber);return n&&(console.log("addEvents",e),g(n.element)),{status:"ok"}},REMOVE_EVENTS_ELEMENTS:e=>{let n=i.find(t=>t.number==e.data.idNumber);return n&&(console.log("Remove Events",e),L(n.element)),{status:"ok"}},CHECK_CONNECTION:()=>({message:"connected"})},D={ELEMENT_ACTION:(e,n)=>{n.status=="received"&&s({cmd:e,data:n}).catch(t=>{console.log(t)})},CHECK_ELEMENT_VIDEO_SELECTED:(e,n)=>{s({cmd:e,data:n})},[o.GET_TABS]:async(e,n)=>{const t=await s({cmd:e,data:n});t&&_(t)},[o.GET_VIDEOS_DATA]:async(e,n)=>{await s({cmd:e,data:n})}};window.addEventListener("message",async function(e){const n=e.data;if(e.source!=window||n._isExtMsg)return;let{cmd:t,data:a}=n;const E=await D[t];E&&E(t,a)},!1),chrome.runtime.onMessage.addListener(function(e,n,t){let a=C[e.cmd];if(a)return a(e,n).then(E=>{t(E)}).catch(E=>{t({err:E})}),!0;t({error:"no existe tal accion"})}),console.log("media-element-selection-extension")})();
