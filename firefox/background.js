(function(){const E={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",CHECK_CONNECTION_UI:"CHECK_CONNECTION_UI",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY",DISPLAY_VIDEOS_ON_SELECTED_PAGE:"DISPLAY_VIDEOS_ON_SELECTED_PAGE"},l=(e,t,c)=>new Promise((a,n)=>{chrome.tabs.sendMessage(Number(e),t,c,i=>{chrome.runtime.lastError?n(chrome.runtime.lastError.message):a(i)})}),T={},I=async e=>{if(!e)return"";if(T[e])return T[e];try{const t=await fetch(e);if(!t.ok)return"";const c=await t.blob(),a=new FileReader,n=await new Promise(i=>{a.onloadend=()=>i(a.result),a.readAsDataURL(c)});return T[e]=n,n}catch{return""}},N=()=>new Promise((e,t)=>{try{chrome.tabs.query({},function(c){Promise.all(c.map(async a=>{const n=await I(a.favIconUrl);return{id:a.id,favIconUrl:n,title:a.title,url:a.url}})).then(a=>e(a))})}catch(c){console.log(c),t(c)}}),S=(e,t)=>new Promise((c,a)=>{const n=typeof browser<"u"?browser:chrome;n.webNavigation.getAllFrames({tabId:e},i=>{i?.forEach(s=>{const d=()=>{n.scripting.executeScript({target:{tabId:Number(e),frameIds:[s.frameId]},files:["content.js"]}).then(()=>{console.log("script execute"),l(e,t,{frameId:s.frameId}).then(r=>{console.log("Mensaje enviado:",r),c(r)}).catch(r=>{console.log("Error al enviar mensaje 2:",r),a(r)})})};l(e,t,{frameId:s.frameId}).then(r=>{r?c(r):d()}).catch(r=>{console.log("Error al enviar mensaje:",r),d()})})})});chrome.runtime.onInstalled.addListener(()=>{console.log("installed")});let _=null,o=null,m=null;function f(){return new Promise(e=>{o&&Object.keys(o).length==0?chrome.storage.local.get(["dataG"],function(t){t.dataG&&(o=JSON.parse(t.dataG)),e("")}):e("")})}const A=e=>{chrome.storage.local.set({dataG:JSON.stringify(e)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener((e,t,c)=>(f().then(async()=>{if(e.cmd==E.ELEMENT_ACTION)if(e.data.status=="sending"){if(!_){console.log("mainAppTabId null");return}l(_,{cmd:e.cmd,data:e.data})}else{if(!o){console.log("no hay elemento seleccionado");return}l(o.tabId,{cmd:e.cmd,data:{...e.data,number:o.number}})}else if(e.cmd==E.CHECK_ELEMENT_VIDEO_SELECTED){let a={selected:!1};if(!o){console.log("no hay elemento seleccionado");return}Object.keys(o).length!=0&&(a={selected:!0}),c({cmd:E.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:a})}else if(e.cmd==E.GET_TABS){const a=await N();c({...e,cmd:E.RESULT_TABS,data:a})}else if(e.cmd==E.GET_VIDEOS_DATA){if(!t.tab?.id)return;S(t.tab?.id,{...e,myTabId:t.tab?.id})}else if(e.cmd==E.RESULT_VIDEOS_DATA){const a=e.data.videos.map(n=>({...n,frameId:t.frameId}));if(!t.tab?.id)return;e.data.videos=a,l(t.tab?.id,e,{frameId:0})}else if(e.cmd==E.ADD_EVENTS_ELEMENT){if(!m)return console.log("faltan favIconUrl tabId");const a=m?.tabId,n=m?.favIconUrl,i=e.data.number,s=e.data.img,d=e.data.frameId;if(o&&o.tabId)try{(await l(o.tabId,{cmd:E.REMOVE_EVENTS_ELEMENTS,data:{number:o.number}})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(r){console.log("error remove",r)}await l(Number(a),{cmd:E.ADD_EVENTS_ELEMENT,data:{number:i}}),o={img:s,tabId:a,number:i,favIconUrl:n,frameId:d},A(o)}else if(e.cmd===E.APP_INSTANCE_ALIVE){const a=t.tab?.id;a!==void 0&&(_!==null&&_!==a&&l(_,{cmd:E.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),_=a,l(_,{cmd:E.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}else if(e.cmd===E.GET_VIDEO_INFO)try{if(!o){console.log("no hay elemento seleccionado");return}c(await l(o.tabId,{...e,data:{number:o.number}},{frameId:o.frameId}))}catch(a){console.log(a)}else if(e.cmd===E.DISPLAY_VIDEOS_ON_SELECTED_PAGE){const a=e.data.tabId;m={tabId:a,favIconUrl:e.data.favIconUrl};const n=i=>{const s=typeof browser<"u"?browser.scripting:chrome.scripting;l(i,{cmd:E.CHECK_CONNECTION_UI},{frameId:0}).then(d=>{console.log("Respuesta del mensaje check connection:",d)}).catch(d=>{console.log("Error al enviar mensaje check connection:",d),s.executeScript({target:{tabId:i},files:["ui/select-video.js"]}).then(()=>{console.log("script execute modal.js")})})};chrome.tabs.update(a,{active:!0},()=>{chrome.tabs.get(a,i=>{i.status==="complete"?n(a):chrome.tabs.onUpdated.addListener(function s(d,r){d===a&&r.status==="complete"&&(chrome.tabs.onUpdated.removeListener(s),n(a))})})})}return!1}),!0))})();
