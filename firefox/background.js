(function(){const n={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY"},r=(a,t)=>new Promise((e,E)=>{chrome.tabs.sendMessage(Number(a),t,o=>{chrome.runtime.lastError?E(chrome.runtime.lastError.message):e(o)})}),i={},d=async a=>{if(!a)return"";if(i[a])return i[a];try{const t=await fetch(a);if(!t.ok)return"";const e=await t.blob(),E=new FileReader,o=await new Promise(_=>{E.onloadend=()=>_(E.result),E.readAsDataURL(e)});return i[a]=o,o}catch{return""}},s=()=>new Promise((a,t)=>{try{chrome.tabs.query({},function(e){Promise.all(e.map(async E=>{const o=await d(E.favIconUrl);return{id:E.id,favIconUrl:o,title:E.title,url:E.url}})).then(E=>a(E))})}catch(e){console.log(e),t(e)}}),l=(a,t)=>new Promise((e,E)=>{r(parseInt(a),t).then(o=>{console.log("Mensaje enviado:",o),e(o)}).catch(o=>{console.log("Error al enviar mensaje:",o),(typeof browser<"u"?browser.scripting:chrome.scripting).executeScript({target:{tabId:parseInt(a),allFrames:!0},files:["content.js"]}).then(()=>{console.log("script execute"),r(parseInt(a),t).then(_=>{console.log("Mensaje enviado:",_),e(_)}).catch(_=>{console.log("Error al enviar mensaje 2:",_),E(_)})})})});chrome.runtime.onInstalled.addListener(()=>{console.log("installed")});let T=null,c={};function S(){return new Promise(a=>{Object.keys(c).length==0?chrome.storage.local.get(["dataG"],function(t){t.dataG&&(c=JSON.parse(t.dataG)),a("")}):a("")})}const m=a=>{chrome.storage.local.set({dataG:JSON.stringify(a)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener(function(a,t,e){return S().then(async()=>{if(a.cmd==n.ELEMENT_ACTION)a.data.status=="sending"?r(T,{cmd:a.cmd,data:a.data}):r(parseInt(c.tabId),{cmd:a.cmd,data:{...a.data,number:c.number}});else if(a.cmd==n.CHECK_ELEMENT_VIDEO_SELECTED){let E={selected:!1};Object.keys(c).length!=0&&(E={selected:!0}),e({cmd:n.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:E})}else if(a.cmd==n.GET_TABS){const E=await s();e({...a,cmd:n.RESULT_TABS,data:E})}else if(a.cmd==n.GET_VIDEOS_DATA)l(a.data.tabId,{...a,myTabId:t.tab.id});else if(a.cmd==n.RESULT_VIDEOS_DATA)r(a.myTabId,{...a,cmd:n.RESULT_VIDEOS_DATA,data:a.data});else if(a.cmd==n.ADD_EVENTS_ELEMENT){const E=a.data.tabId,o=a.data.number,_=a.data.img,A=a.data.favIconUrl;if(c.tabId)try{(await r(parseInt(c.tabId),{cmd:n.REMOVE_EVENTS_ELEMENTS,data:{number:c.number}})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(N){console.log("error remove",N)}await r(Number(E),{cmd:n.ADD_EVENTS_ELEMENT,data:{number:o}}),c={img:_,tabId:E,number:o,favIconUrl:A},m(c)}else if(a.cmd===n.APP_INSTANCE_ALIVE){const E=t.tab?.id;E!==void 0&&(T!==null&&T!==E&&r(T,{cmd:n.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),T=E,r(T,{cmd:n.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}e({data:"no se encontro coincidencia"})}),!0})})();
