(function(){const n={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY"},r=(a,E)=>new Promise((t,e)=>{chrome.tabs.sendMessage(Number(a),E,c=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(c)})}),_={},T=async a=>{if(!a)return"";if(_[a])return _[a];try{const E=await fetch(a);if(!E.ok)return"";const t=await E.blob(),e=new FileReader,c=await new Promise(l=>{e.onloadend=()=>l(e.result),e.readAsDataURL(t)});return _[a]=c,c}catch{return""}},d=()=>new Promise((a,E)=>{try{chrome.tabs.query({},function(t){Promise.all(t.map(async e=>{const c=await T(e.favIconUrl);return{id:e.id,favIconUrl:c,title:e.title,url:e.url}})).then(e=>a(e))})}catch(t){console.log(t),E(t)}}),s=(a,E)=>new Promise((t,e)=>{r(a,E).then(c=>{console.log("Mensaje enviado:",c),t(c)}).catch(c=>{console.log("Error al enviar mensaje:",c),(typeof browser<"u"?browser.scripting:chrome.scripting).executeScript({target:{tabId:Number(a),allFrames:!0},files:["content.js"]}).then(()=>{console.log("script execute"),r(a,E).then(l=>{console.log("Mensaje enviado:",l),t(l)}).catch(l=>{console.log("Error al enviar mensaje 2:",l),e(l)})})})});chrome.runtime.onInstalled.addListener(()=>{console.log("installed")});let i=null,o=null;function m(){return new Promise(a=>{o&&Object.keys(o).length==0?chrome.storage.local.get(["dataG"],function(E){E.dataG&&(o=JSON.parse(E.dataG)),a("")}):a("")})}const S=a=>{chrome.storage.local.set({dataG:JSON.stringify(a)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener((a,E,t)=>(m().then(async()=>{if(a.cmd==n.ELEMENT_ACTION)if(a.data.status=="sending"){if(!i){console.log("mainAppTabId null");return}r(i,{cmd:a.cmd,data:a.data})}else{if(!o){console.log("no hay elemento seleccionado");return}r(o.tabId,{cmd:a.cmd,data:{...a.data,number:o.number}})}else if(a.cmd==n.CHECK_ELEMENT_VIDEO_SELECTED){let e={selected:!1};if(!o){console.log("no hay elemento seleccionado");return}Object.keys(o).length!=0&&(e={selected:!0}),t({cmd:n.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:e})}else if(a.cmd==n.GET_TABS){const e=await d();t({...a,cmd:n.RESULT_TABS,data:e})}else if(a.cmd==n.GET_VIDEOS_DATA)s(a.data.tabId,{...a,myTabId:E.tab?.id});else if(a.cmd==n.RESULT_VIDEOS_DATA)r(a.myTabId,{...a,cmd:n.RESULT_VIDEOS_DATA,data:a.data});else if(a.cmd==n.ADD_EVENTS_ELEMENT){const e=a.data.tabId,c=a.data.number,l=a.data.img,A=a.data.favIconUrl;if(o&&o.tabId)try{(await r(o.tabId,{cmd:n.REMOVE_EVENTS_ELEMENTS,data:{number:o.number}})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(N){console.log("error remove",N)}await r(Number(e),{cmd:n.ADD_EVENTS_ELEMENT,data:{number:c}}),o={img:l,tabId:e,number:c,favIconUrl:A},S(o)}else if(a.cmd===n.APP_INSTANCE_ALIVE){const e=E.tab?.id;e!==void 0&&(i!==null&&i!==e&&r(i,{cmd:n.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),i=e,r(i,{cmd:n.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}t({data:"no se encontro coincidencia"})}),!0))})();
