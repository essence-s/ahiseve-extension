(function(){const E={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",CHECK_CONNECTION_UI:"CHECK_CONNECTION_UI",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY",DISPLAY_VIDEOS_ON_SELECTED_PAGE:"DISPLAY_VIDEOS_ON_SELECTED_PAGE",HIDDEN_UI:"HIDDEN_UI",SAVE_TAB_INFO:"SAVE_TAB_INFO",ENABLE_VIDEO_DETECTOR:"ENABLE_VIDEO_DETECTOR",DISABLE_VIDEO_DETECTOR:"DISABLE_VIDEO_DETECTOR",VIDEO_DETECTOR_STATUS:"VIDEO_DETECTOR_STATUS"},r=(e,a,o)=>new Promise((t,n)=>{chrome.tabs.sendMessage(Number(e),a,o,i=>{chrome.runtime.lastError?n(chrome.runtime.lastError.message):t(i)})}),I={},S=async e=>{if(!e)return"";if(I[e])return I[e];try{const a=await fetch(e);if(!a.ok)return"";const o=await a.blob(),t=new FileReader,n=await new Promise(i=>{t.onloadend=()=>i(t.result),t.readAsDataURL(o)});return I[e]=n,n}catch{return""}},f=()=>new Promise((e,a)=>{try{chrome.tabs.query({},function(o){Promise.all(o.map(async t=>{const n=await S(t.favIconUrl);return{id:t.id,favIconUrl:n,title:t.title,url:t.url}})).then(t=>e(t))})}catch(o){console.log(o),a(o)}}),A=(e,a)=>new Promise((o,t)=>{const n=typeof browser<"u"?browser:chrome;n.webNavigation.getAllFrames({tabId:e},i=>{i?.forEach(s=>{const l=()=>{n.scripting.executeScript({target:{tabId:Number(e),frameIds:[s.frameId]},files:["content.js"]}).then(()=>{console.log("script execute"),r(e,a,{frameId:s.frameId}).then(d=>{console.log("Mensaje enviado:",d),o(d)}).catch(d=>{console.log("Error al enviar mensaje 2:",d),t(d)})})};r(e,a,{frameId:s.frameId}).then(d=>{d?o(d):l()}).catch(d=>{console.log("Error al enviar mensaje:",d),l()})})})}),N=typeof browser<"u"?browser.scripting:chrome.scripting;chrome.runtime.onInstalled.addListener(()=>{console.log("installed")});const O=["https://ahiseve.vercel.app","https://ahiseve-git-dev-essence-s-projects.vercel.app"];let T=!1;const m=new Set;async function D(e){chrome.tabs.get(e,async a=>{if(a.url&&!O.some(o=>a.url?.includes(o))){try{const o=await r(e,{cmd:E.CHECK_CONNECTION_UI},{frameId:0});if(o&&o.status)return}catch{}N.executeScript({target:{tabId:e},files:["ui/select-video.js"]}).then(()=>{console.log("script execute modal.js"),m.add(e)})}})}chrome.tabs.onActivated.addListener(e=>{T&&D(e.tabId)}),chrome.tabs.onUpdated.addListener((e,a,o)=>{T&&a.status==="complete"&&D(e)});let _=null,c=null;function C(){return new Promise(e=>{c&&Object.keys(c).length==0?chrome.storage.local.get(["dataG"],function(a){a.dataG&&(c=JSON.parse(a.dataG)),e("")}):e("")})}const L=e=>{chrome.storage.local.set({dataG:JSON.stringify(e)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener((e,a,o)=>(C().then(async()=>{if(e.cmd==E.ELEMENT_ACTION)if(e.data.status=="sending"){if(!_){console.log("mainAppTabId null");return}r(_,{cmd:e.cmd,data:e.data})}else{if(!c){console.log("no hay elemento seleccionado");return}r(c.tabId,{cmd:e.cmd,data:{...e.data,number:c.number}})}else if(e.cmd==E.CHECK_ELEMENT_VIDEO_SELECTED){let t={selected:!1};if(!c){console.log("no hay elemento seleccionado");return}Object.keys(c).length!=0&&(t={selected:!0}),o({cmd:E.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:t})}else if(e.cmd==E.GET_TABS){const t=await f();o({...e,cmd:E.RESULT_TABS,data:t})}else if(e.cmd==E.GET_VIDEOS_DATA){if(!a.tab?.id)return;A(a.tab?.id,{...e,myTabId:a.tab?.id})}else if(e.cmd==E.RESULT_VIDEOS_DATA){const t=e.data.videos.map(n=>({...n,frameId:a.frameId}));if(!a.tab?.id)return;e.data.videos=t,r(a.tab?.id,e,{frameId:0})}else if(e.cmd==E.ADD_EVENTS_ELEMENT){const t=a.tab?.id;if(!t)return console.log("tabId no existe");const n=e.data.number,i=e.data.img,s=e.data.frameId;if(c&&c.tabId)try{(await r(c.tabId,{cmd:E.REMOVE_EVENTS_ELEMENTS,data:{number:c.number}},{frameId:c.frameId})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(l){console.log("error remove",l)}if(await r(Number(t),{cmd:E.ADD_EVENTS_ELEMENT,data:{number:n}},{frameId:s}),c={img:i,tabId:t,number:n,frameId:s},T=!1,m.forEach(l=>{r(l,{cmd:E.HIDDEN_UI})}),!_)return console.log("no existe mainAppTabId");r(_,{cmd:E.VIDEO_DETECTOR_STATUS,data:!1}),L(c)}else if(e.cmd===E.APP_INSTANCE_ALIVE){const t=a.tab?.id;t!==void 0&&(_!==null&&_!==t&&r(_,{cmd:E.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),_=t,r(_,{cmd:E.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}else if(e.cmd===E.GET_VIDEO_INFO)try{if(!c){console.log("no hay elemento seleccionado");return}o(await r(c.tabId,{...e,data:{number:c.number}},{frameId:c.frameId}))}catch(t){console.log(t)}else if(e.cmd===E.DISPLAY_VIDEOS_ON_SELECTED_PAGE){const t=e.data.tabId;e.data.favIconUrl;const n=i=>{r(i,{cmd:E.CHECK_CONNECTION_UI},{frameId:0}).then(s=>{console.log("Respuesta del mensaje check connection:",s)}).catch(s=>{console.log("Error al enviar mensaje check connection:",s),N.executeScript({target:{tabId:i},files:["ui/select-video.js"]}).then(()=>{console.log("script execute modal.js")})})};chrome.tabs.update(t,{active:!0},()=>{chrome.tabs.get(t,i=>{i.status==="complete"?n(t):chrome.tabs.onUpdated.addListener(function s(l,d){l===t&&d.status==="complete"&&(chrome.tabs.onUpdated.removeListener(s),n(t))})})})}else e.cmd===E.ENABLE_VIDEO_DETECTOR?T=!0:e.cmd===E.DISABLE_VIDEO_DETECTOR&&(T=!1,m.forEach(t=>{r(t,{cmd:E.HIDDEN_UI})}));return!1}),!0))})();
