(function(){const o={ELEMENT_ACTION:"ELEMENT_ACTION",GET_VIDEOS_DATA:"GET_VIDEOS_DATA",RESULT_VIDEOS_DATA:"RESULT_VIDEOS_DATA",GET_VIDEO_INFO:"GET_VIDEO_INFO",RESULT_VIDEO_INFO:"RESULT_VIDEO_INFO",GET_TABS:"GET_TABS",RESULT_TABS:"RESULT_TABS",CHECK_ELEMENT_VIDEO_SELECTED:"CHECK_ELEMENT_VIDEO_SELECTED",RESULT_CHECK_ELEMENT_VIDEO_SELECTED:"RESULT_CHECK_ELEMENT_VIDEO_SELECTED",ADD_EVENTS_ELEMENT:"ADD_EVENTS_ELEMENT",REMOVE_EVENTS_ELEMENTS:"REMOVE_EVENTS_ELEMENTS",CHECK_CONNECTION:"CHECK_CONNECTION",CHECK_CONNECTION_UI:"CHECK_CONNECTION_UI",APP_INSTANCE_ALIVE:"APP_INSTANCE_ALIVE",APP_INSTANCE_LOST_PRIMARY:"APP_INSTANCE_LOST_PRIMARY",APP_INSTANCE_NOW_PRIMARY:"APP_INSTANCE_NOW_PRIMARY",DISPLAY_VIDEOS_ON_SELECTED_PAGE:"DISPLAY_VIDEOS_ON_SELECTED_PAGE",HIDDEN_UI:"HIDDEN_UI",SAVE_TAB_INFO:"SAVE_TAB_INFO",ENABLE_VIDEO_DETECTOR:"ENABLE_VIDEO_DETECTOR",DISABLE_VIDEO_DETECTOR:"DISABLE_VIDEO_DETECTOR",VIDEO_DETECTOR_STATUS:"VIDEO_DETECTOR_STATUS"},r=(e,a,E)=>new Promise((t,c)=>{chrome.tabs.sendMessage(Number(e),a,E,s=>{chrome.runtime.lastError?c(chrome.runtime.lastError.message):t(s)})}),I={},S=async e=>{if(!e)return"";if(I[e])return I[e];try{const a=await fetch(e);if(!a.ok)return"";const E=await a.blob(),t=new FileReader,c=await new Promise(s=>{t.onloadend=()=>s(t.result),t.readAsDataURL(E)});return I[e]=c,c}catch{return""}},f=()=>new Promise((e,a)=>{try{chrome.tabs.query({},function(E){Promise.all(E.map(async t=>{const c=await S(t.favIconUrl);return{id:t.id,favIconUrl:c,title:t.title,url:t.url}})).then(t=>e(t))})}catch(E){console.log(E),a(E)}}),A=(e,a)=>new Promise((E,t)=>{const c=typeof browser<"u"?browser:chrome;c.webNavigation.getAllFrames({tabId:e},s=>{s?.forEach(i=>{const _=()=>{c.scripting.executeScript({target:{tabId:Number(e),frameIds:[i.frameId]},files:["content.js"]}).then(()=>{console.log("script execute"),r(e,a,{frameId:i.frameId}).then(d=>{console.log("Mensaje enviado:",d),E(d)}).catch(d=>{console.log("Error al enviar mensaje 2:",d),t(d)})})};r(e,a,{frameId:i.frameId}).then(d=>{d?E(d):_()}).catch(d=>{console.log("Error al enviar mensaje:",d),_()})})})}),O=e=>{chrome.tabs.query({url:e},a=>{a.forEach(E=>{const t=E.id;t&&r(t,{cmd:o.CHECK_CONNECTION}).then(c=>{c.message=="connected"&&console.log(c,"ya esta conectado")}).catch(c=>{chrome.scripting.executeScript({target:{tabId:t},files:["app-content.ts"]}).then(()=>{console.log("script injected")})})})})},N=typeof browser<"u"?browser.scripting:chrome.scripting;chrome.runtime.onInstalled.addListener(()=>{console.log("installed")}),O(["https://ahiseve.vercel.app/*","https://ahiseve-git-dev-essence-s-projects.vercel.app/*"]);const C=["https://ahiseve.vercel.app","http://localhost:4321","https://k0gd49gv-4322.brs.devtunnels.ms","https://ahiseve-git-dev-essence-s-projects.vercel.app"];let T=!1;const m=new Set;async function D(e){chrome.tabs.get(e,async a=>{if(a.url&&!C.some(E=>a.url?.includes(E))){try{const E=await r(e,{cmd:o.CHECK_CONNECTION_UI},{frameId:0});if(E&&E.status)return}catch{}N.executeScript({target:{tabId:e},files:["ui/select-video.js"]}).then(()=>{console.log("script execute modal.js"),m.add(e)})}})}chrome.tabs.onActivated.addListener(e=>{T&&D(e.tabId)}),chrome.tabs.onUpdated.addListener((e,a,E)=>{T&&a.status==="complete"&&D(e)});let l=null,n=null;function h(){return new Promise(e=>{n&&Object.keys(n).length==0?chrome.storage.local.get(["dataG"],function(a){a.dataG&&(n=JSON.parse(a.dataG)),e("")}):e("")})}const L=e=>{chrome.storage.local.set({dataG:JSON.stringify(e)},function(){console.log("Datos almacenados en el localStorage del background:")})};chrome.runtime.onMessage.addListener((e,a,E)=>(h().then(async()=>{if(e.cmd==o.ELEMENT_ACTION)if(e.data.status=="sending"){if(!l){console.log("mainAppTabId null");return}r(l,{cmd:e.cmd,data:e.data})}else{if(!n){console.log("no hay elemento seleccionado");return}r(n.tabId,{cmd:e.cmd,data:{...e.data,number:n.number}})}else if(e.cmd==o.CHECK_ELEMENT_VIDEO_SELECTED){let t={selected:!1};if(!n){console.log("no hay elemento seleccionado");return}Object.keys(n).length!=0&&(t={selected:!0}),E({cmd:o.RESULT_CHECK_ELEMENT_VIDEO_SELECTED,data:t})}else if(e.cmd==o.GET_TABS){const t=await f();E({...e,cmd:o.RESULT_TABS,data:t})}else if(e.cmd==o.GET_VIDEOS_DATA){if(!a.tab?.id)return;A(a.tab?.id,{...e,myTabId:a.tab?.id})}else if(e.cmd==o.RESULT_VIDEOS_DATA){const t=e.data.videos.map(c=>({...c,frameId:a.frameId}));if(!a.tab?.id)return;e.data.videos=t,r(a.tab?.id,e,{frameId:0})}else if(e.cmd==o.ADD_EVENTS_ELEMENT){const t=a.tab?.id;if(!t)return console.log("tabId no existe");const c=e.data.number,s=e.data.img,i=e.data.frameId;if(n&&n.tabId)try{(await r(n.tabId,{cmd:o.REMOVE_EVENTS_ELEMENTS,data:{number:n.number}},{frameId:n.frameId})).status=="ok"&&console.log("se removio eventos de seleccion anterior")}catch(_){console.log("error remove",_)}if(await r(Number(t),{cmd:o.ADD_EVENTS_ELEMENT,data:{number:c}},{frameId:i}),n={img:s,tabId:t,number:c,frameId:i},T=!1,m.forEach(_=>{r(_,{cmd:o.HIDDEN_UI})}),!l)return console.log("no existe mainAppTabId");r(l,{cmd:o.VIDEO_DETECTOR_STATUS,data:!1}),L(n)}else if(e.cmd===o.APP_INSTANCE_ALIVE){const t=a.tab?.id;t!==void 0&&(l!==null&&l!==t&&r(l,{cmd:o.APP_INSTANCE_LOST_PRIMARY}).catch(()=>{}),l=t,r(l,{cmd:o.APP_INSTANCE_NOW_PRIMARY}).catch(()=>{}))}else if(e.cmd===o.GET_VIDEO_INFO)try{if(!n){console.log("no hay elemento seleccionado");return}E(await r(n.tabId,{...e,data:{number:n.number}},{frameId:n.frameId}))}catch(t){console.log(t)}else if(e.cmd===o.DISPLAY_VIDEOS_ON_SELECTED_PAGE){const t=e.data.tabId;e.data.favIconUrl;const c=s=>{r(s,{cmd:o.CHECK_CONNECTION_UI},{frameId:0}).then(i=>{console.log("Respuesta del mensaje check connection:",i)}).catch(i=>{console.log("Error al enviar mensaje check connection:",i),N.executeScript({target:{tabId:s},files:["ui/select-video.js"]}).then(()=>{console.log("script execute modal.js")})})};chrome.tabs.update(t,{active:!0},()=>{chrome.tabs.get(t,s=>{s.status==="complete"?c(t):chrome.tabs.onUpdated.addListener(function i(_,d){_===t&&d.status==="complete"&&(chrome.tabs.onUpdated.removeListener(i),c(t))})})})}else e.cmd===o.ENABLE_VIDEO_DETECTOR?T=!0:e.cmd===o.DISABLE_VIDEO_DETECTOR&&(T=!1,m.forEach(t=>{r(t,{cmd:o.HIDDEN_UI})}));return!1}),!0))})();
